<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Mark Attendance</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .students-section {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="mt-5 mb-3 text-center">Mark Attendance</h1>

        <!-- Lab Selection -->
        <div class="form-group row">
            <label for="labCode" class="col-sm-2 col-form-label">Select Lab</label>
            <div class="col-sm-10">
                <select id="labCode" class="form-control" onchange="fetchStudents()">
                    <option value="" disabled selected>Select a lab...</option>
                </select>
            </div>
        </div>

        <!-- Students List -->
        <div id="studentsSection" class="students-section">
            <h3 class="mb-3">Enrolled Students</h3>
            <ul id="studentsList" class="list-group mb-4"></ul>

            <!-- Mark Attendance Button -->
            <button id="markAttendanceBtn" class="btn btn-primary btn-block" onclick="markAttendance()">
                Mark Attendance
            </button>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Fetch labs on page load
        function fetchLabs() {
            const url = `/api/lab/active`;
            const token = localStorage.getItem('token');

            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch active labs');
                    }
                    return response.json();
                })
                .then(data => {
                    const labCodeSelect = document.getElementById("labCode");
                    labCodeSelect.innerHTML = `<option value="" disabled selected>Select a lab...</option>`;

                    (data.activeLabs || []).forEach(lab => {
                        const option = document.createElement("option");
                        option.value = lab.labCode;
                        option.textContent = `${lab.labName} (${lab.labCode})`;
                        labCodeSelect.appendChild(option);
                    });
                })
                .catch(error => console.error("Error fetching active labs:", error));
        }

        document.addEventListener("DOMContentLoaded", fetchLabs);

        // Fetch students for the selected lab
        function fetchStudents() {
            const labCode = document.getElementById("labCode").value;
            if (!labCode) return;

            const token = localStorage.getItem("token");

            fetch(`/api/lab/user/${labCode}`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to fetch students");
                    }
                    return response.json();
                })
                .then(data => {
                    const studentsSection = document.getElementById("studentsSection");
                    const studentsList = document.getElementById("studentsList");
                    studentsList.innerHTML = "";

                    const students = data.students?.[0]?.students || [];

                    if (students.length === 0) {
                        const noStudentsMsg = document.createElement("li");
                        noStudentsMsg.className = "list-group-item text-center";
                        noStudentsMsg.textContent = "No students enrolled in this lab.";
                        studentsList.appendChild(noStudentsMsg);
                    } else {
                        students.forEach(student => {
                            const li = document.createElement("li");
                            li.className = "list-group-item d-flex justify-content-between align-items-center";
                            li.innerHTML = `
                                ${student.name} (Roll No: ${student.rollNo})
                                <input type="checkbox" class="form-check-input" value="${student.rollNo}">
                            `;
                            studentsList.appendChild(li);
                        });
                    }

                    studentsSection.style.display = "block";
                })
                .catch(error => console.error("Error fetching students:", error));
        }

        // Mark attendance
		// Mark attendance
		function markAttendance() {
		    const labCode = document.getElementById("labCode").value;
		    const checkboxes = document.querySelectorAll("#studentsList input[type=checkbox]");
		    const presentRollNos = Array.from(checkboxes)
		        .filter(checkbox => checkbox.checked)
		        .map(checkbox => checkbox.value);

		    const token = localStorage.getItem("token");
		    fetch("/api/attendance/mark", {
		        method: "POST",
		        headers: {
		            "Content-Type": "application/json",
		            "Authorization": `Bearer ${token}`
		        },
		        body: JSON.stringify({
		            labSessionId: labCode,
		            studentRollNos: presentRollNos
		        })
		    })
		        .then(response => response.json())
		        .then(data => {
		            alert(data.message || "Attendance marked successfully");

		            // Redirect to dashboard after successful attendance marking
		            window.location.href = "/api/auth/dashboard"; // Replace with your actual dashboard URL
		        })
		        .catch(error => {
		            console.error("Error marking attendance:", error);
		            alert("Failed to mark attendance. Please try again.");
		        });
		}

    </script>

    <!-- Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
